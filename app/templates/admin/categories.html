{% extends "admin/admin_layout.html" %}

{% block content %}
<div class="container-fluid py-4 px-lg-5">
    <div class="row mb-4 align-items-center g-3">
        <div class="col-12 col-md-6">
            <h2 class="text-white fw-bold mb-1">Master Kategori</h2>
            <p class="text-muted small mb-0">Kelola kategori laporan warga untuk sistem DishubAdmin.</p>
        </div>
        <div class="col-12 col-md-6 text-md-end">
            <button class="btn btn-primary shadow-sm rounded-pill px-4 py-2 fw-bold w-100 w-md-auto" data-bs-toggle="modal" data-bs-target="#modalAddCategory">
                <i class="bi bi-plus-lg me-2"></i> Tambah Kategori
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="card bg-dark border-secondary border-opacity-25 shadow-sm rounded-4">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-3 p-3 me-3">
                        <i class="bi bi-tags fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block small-text">Total Kategori</small>
                        <span class="text-white h5 fw-bold mb-0">{{ categories|length }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary border-opacity-25 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white bg-opacity-5 border-bottom border-secondary border-opacity-25 py-3 d-flex justify-content-between align-items-center">
            <h6 class="text-white mb-0"><i class="bi bi-table me-2"></i> Daftar Kategori Aktif</h6>
            <span class="badge bg-primary bg-opacity-10 text-primary fw-normal small d-none d-sm-inline">Terhubung ke Sidebar</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0 custom-table">
                    <thead class="text-muted small text-uppercase bg-black bg-opacity-20">
                        <tr>
                            <th class="px-4 py-3 border-0">Icon</th>
                            <th class="py-3 border-0">Nama Kategori</th>
                            <th class="py-3 border-0 d-none d-md-table-cell">Slug Preview</th>
                            <th class="py-3 border-0 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% if categories %}
                            {% for cat in categories %}
                            <tr>
                                <td class="px-4">
                                    <div class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center shadow-sm" style="width: 42px; height: 42px;">
                                        <i class="bi {{ cat.icon or 'bi-tag' }} fs-5"></i>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-white fw-semibold d-block">{{ cat.name }}</span>
                                    <small class="text-muted d-md-none small">/{{ cat.name|lower|replace(' ', '-') }}</small>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    <code class="text-info opacity-75 small">/{{ cat.name|lower|replace(' ', '-') }}</code>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        {# PERBAIKAN: Menggunakan cat_id sesuai routes.py #}
                                        <form action="{{ url_for('admin.delete_category', cat_id=cat.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Menghapus kategori ini akan mempengaruhi filter di sidebar dan laporan. Lanjutkan?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm rounded-3 border-opacity-50 hover-shake">
                                                <i class="bi bi-trash3"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <div class="text-muted opacity-50">
                                        <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                        <p class="mb-0">Belum ada kategori yang tersinkron.</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddCategory" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg rounded-4">
            <div class="modal-header border-secondary border-opacity-25 py-3">
                <h5 class="modal-title text-white fw-bold"><i class="bi bi-plus-circle me-2 text-primary"></i> Tambah Kategori</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.manage_categories') }}" method="POST">
                <div class="modal-body py-4">
                    <div class="mb-4 text-center">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-glow" style="width: 80px; height: 80px; border: 2px dashed rgba(13, 110, 253, 0.3);">
                            <i id="icon-preview" class="bi bi-tag fs-1"></i>
                        </div>
                        <p class="small text-muted mb-0">Preview Tampilan Sidebar</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white-50 small fw-bold text-uppercase">Nama Kategori</label>
                        <input type="text" name="name" class="form-control bg-dark border-secondary text-white py-2 px-3 focus-blue rounded-3" placeholder="Contoh: Lampu Jalan, Jalan Berlubang" required>
                        <div class="form-text text-muted small">Nama ini akan muncul sebagai menu di sidebar.</div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label text-white-50 small fw-bold text-uppercase">Bootstrap Icon Class</label>
                        <div class="input-group">
                            <span class="input-group-text bg-secondary bg-opacity-10 border-secondary text-white-50">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="icon-input" name="icon" class="form-control bg-dark border-secondary text-white py-2 focus-blue" placeholder="bi-lightbulb" value="bi-tag" required>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted small-text">Gunakan prefix <b>bi-</b></small>
                            <small><a href="https://icons.getbootstrap.com/" target="_blank" class="text-primary text-decoration-none small">Lihat Katalog Icon <i class="bi bi-box-arrow-up-right ms-1"></i></a></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4 rounded-pill small fw-bold" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary px-5 rounded-pill fw-bold shadow-glow-primary">Simpan & Sinkronkan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Dark Theme Core */
    .bg-dark { background-color: #121417 !important; }
    .small-text { font-size: 0.7rem; letter-spacing: 0.5px; }

    /* Modern Table UI */
    .custom-table tbody tr { border-bottom: 1px solid rgba(255,255,255,0.02); transition: all 0.2s; }
    .custom-table tbody tr:last-child { border-bottom: none; }
    .custom-table tbody tr:hover { background-color: rgba(13, 110, 253, 0.04) !important; }

    /* Interaction & Animations */
    .hover-shake:hover { transform: scale(1.15) rotate(5deg); color: #ff4757 !important; border-color: #ff4757 !important; transition: all 0.2s; }

    .focus-blue:focus {
        background-color: rgba(13, 110, 253, 0.05) !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15) !important;
        color: white;
    }

    /* Aesthetics */
    .shadow-glow { box-shadow: 0 0 20px rgba(13, 110, 253, 0.15); }
    .shadow-glow-primary { box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4); }
    .modal-content { border: 1px solid rgba(255, 255, 255, 0.08); }
    .icon-shape { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }

    /* Responsive Logic */
    @media (max-width: 768px) {
        .container-fluid { padding-left: 1rem !important; padding-right: 1rem !important; }
        .btn-primary { padding: 12px; }
    }
</style>

<script>
    // Live Icon Previewing
    const iconInput = document.getElementById('icon-input');
    const iconPreview = document.getElementById('icon-preview');

    iconInput.addEventListener('input', function(e) {
        let val = e.target.value.trim();
        // Auto-fix if user forgets 'bi-'
        if(val && !val.startsWith('bi-') && !val.startsWith('fa-')) {
            val = 'bi-' + val;
        }
        iconPreview.className = 'bi ' + (val || 'bi-tag') + ' fs-1';
    });

    // Auto-focus input when modal opens
    const myModal = document.getElementById('modalAddCategory');
    myModal.addEventListener('shown.bs.modal', () => {
        document.querySelector('input[name="name"]').focus();
    });
</script>
{% endblock %}