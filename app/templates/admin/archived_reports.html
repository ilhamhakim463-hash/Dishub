{% extends "admin/admin_layout.html" %}
{% block title %}Gudang Arsip Laporan | Enterprise{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-3 px-md-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.reports') }}" class="text-decoration-none">Log Laporan</a></li>
            <li class="breadcrumb-item active">Gudang Arsip</li>
        </ol>
    </nav>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h2 class="fw-bold text-dark mb-1">Gudang Arsip Laporan</h2>
            <p class="text-muted mb-0">Manajemen data laporan yang telah diarsipkan (Tersembunyi dari Dashboard)</p>
        </div>
        <div>
            <a href="{{ url_for('admin.reports') }}" class="btn btn-white bg-white border shadow-sm rounded-pill px-4">
                <i class="bi bi-arrow-left me-2"></i>Kembali ke Log Utama
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="input-group shadow-sm" style="border-radius: 12px; overflow: hidden;">
                <span class="input-group-text border-0 bg-white"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="archiveSearch" class="form-control border-0 py-2" placeholder="Cari di arsip ini...">
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-8 d-flex justify-content-md-end align-items-center">
            <div class="badge bg-dark px-3 py-2 rounded-pill shadow-sm">
                Total Arsip: {{ pagination.total if pagination else reports|length }} Data
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="border-radius: 20px; overflow: hidden;">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 border-0 text-muted small fw-bold" style="width: 80px;">ID</th>
                        <th class="border-0 text-muted small fw-bold">DETAIL LAPORAN</th>
                        <th class="border-0 text-muted small fw-bold text-center">STATUS TERAKHIR</th>
                        <th class="border-0 text-muted small fw-bold text-center">AKSI PEMULIHAN</th>
                    </tr>
                </thead>
                <tbody id="archiveTableBody">
                    {% for report in reports %}
                    <tr>
                        <td class="ps-4">
                            <span class="text-muted fw-bold small">#{{ report.id }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="icon-box bg-light rounded-3 p-2 me-3 d-none d-sm-block">
                                    <i class="bi bi-archive text-secondary fs-4"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark text-truncate" style="max-width: 250px;">{{ report.judul }}</div>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar-event me-1"></i>{{ report.created_at.strftime('%d %b %Y, %H:%M') }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            {% set status = report.status_warna|lower %}
                            <span class="badge status-pill bg-{{ status if status in ['merah', 'kuning', 'biru'] else 'abu' }} px-3 py-2">
                                {{ (report.status_warna or 'PROSES')|upper }}
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-restore btn-sm rounded-pill px-4 py-2 fw-bold shadow-sm"
                                    onclick="toggleArchive({{ report.id }}, 'unarchive')">
                                <i class="bi bi-arrow-up-circle me-2"></i>Pulihkan
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <div class="py-4">
                                <i class="bi bi-inbox-fill display-1 text-light opacity-25"></i>
                                <h5 class="mt-3 text-muted">Gudang arsip masih kosong</h5>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if pagination and pagination.pages > 1 %}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 gap-3">
        <div class="text-muted small">
            Menampilkan <b>{{ reports|length }}</b> dari <b>{{ pagination.total }}</b> laporan terarsip
        </div>

        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0 shadow-sm border-radius-10">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                    <a class="page-link py-2 px-3" href="{{ url_for('admin.archived_reports', page=pagination.prev_num) if pagination.has_prev else '#' }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if page_num == pagination.page }}">
                            <a class="page-link py-2 px-3" href="{{ url_for('admin.archived_reports', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link py-2 px-3">...</span></li>
                    {% endif %}
                {% endfor %}

                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                    <a class="page-link py-2 px-3" href="{{ url_for('admin.archived_reports', page=pagination.next_num) if pagination.has_next else '#' }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<style>
    body { background-color: #f8f9fa; }
    .btn-white { transition: all 0.2s; color: #555; font-weight: 500; }
    .btn-white:hover { background-color: #f8f9fa !important; transform: translateY(-2px); }

    .bg-merah { background-color: #ef4444 !important; color: white; }
    .bg-kuning { background-color: #f59e0b !important; color: white !important; }
    .bg-biru { background-color: #3b82f6 !important; color: white; }
    .bg-abu { background-color: #94a3b8 !important; color: white; }

    .status-pill { font-size: 0.7rem; letter-spacing: 0.5px; min-width: 85px; border-radius: 6px; }

    .btn-restore {
        background-color: #10b981;
        color: white;
        border: none;
        transition: all 0.3s ease;
    }
    .btn-restore:hover {
        background-color: #059669;
        color: white;
        transform: scale(1.05);
    }

    .page-link { border: none; color: #475569; font-weight: 500; margin: 0 2px; }
    .page-item.active .page-link { background-color: #334155 !important; color: white !important; border-radius: 8px; }

    .icon-box { border: 1px solid #e2e8f0; }
</style>

<script>
function toggleArchive(id, action) {
    // Menggunakan confirm standar agar pasti jalan tanpa library SweetAlert
    if (confirm('Pulihkan laporan ini ke dashboard utama?')) {
        fetch(`/admin/report/${id}/archive/${action}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                window.location.reload();
            } else {
                alert('Gagal memulihkan laporan.');
            }
        })
        .catch(err => {
            console.error("Error:", err);
            alert('Terjadi kesalahan koneksi.');
        });
    }
}

document.getElementById('archiveSearch').addEventListener('keyup', function() {
    let value = this.value.toLowerCase();
    let rows = document.querySelectorAll('#archiveTableBody tr');
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
    });
});
</script>
{% endblock %}