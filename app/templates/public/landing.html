{% extends "base.html" %}
{% block title %}Beranda - LaporPak Jombang Enterprise{% endblock %}

{% block content %}
<section class="hero-header position-relative overflow-hidden text-white"
         style="background: linear-gradient(rgba(13, 110, 253, 0.85), rgba(10, 88, 202, 0.95)), url('/static/img/bg-jombang.jpg') center/cover; padding: 100px 0;">
    <div class="container position-relative z-2">
        <div class="row justify-content-center text-center">
            <div class="col-lg-9 animate__animated animate__fadeIn">
                <div class="d-flex justify-content-center align-items-center mb-4">
                    <img src="/static/img/img2.png" alt="Logo Jombang" height="65" class="animate__animated animate__fadeInLeft">
                    <div class="vr bg-white mx-4 opacity-50" style="height: 50px; width: 2px;"></div>
                    <img src="/static/img/img1.png" alt="Logo Terkait" height="60" class="animate__animated animate__fadeInRight">
                </div>

                <h1 class="display-3 fw-bolder mb-3 text-uppercase" style="letter-spacing: -1px;">Suara Anda, Perubahan Kami</h1>
                <p class="lead mb-5 px-md-5 opacity-90">Platform Pelaporan & Peringatan Dini Terpadu Kabupaten Jombang. Laporan Anda dipantau langsung oleh Dishub & Instansi terkait.</p>

                <div class="d-grid gap-3 d-sm-flex justify-content-sm-center mb-2">
                    <a href="{{ url_for('auth.register') }}" class="btn btn-warning btn-lg px-5 py-3 rounded-pill fw-bolder shadow-lg transform-hover text-dark">
                        <i class="bi bi-pencil-square me-2"></i> MULAI MELAPOR
                    </a>
                    <a href="#peta-pantauan" class="btn btn-outline-light btn-lg px-5 py-3 rounded-pill fw-bold border-2">
                        <i class="bi bi-geo-alt me-2"></i> PETA PANTAUAN
                    </a>
                </div>
                <p class="small mt-3 opacity-75 italic">*Terintegrasi dengan Command Center 112 Jombang</p>
            </div>
        </div>
    </div>
    <div class="position-absolute bottom-0 start-0 w-100">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
            <path fill="#ffffff" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,250.7C960,235,1056,181,1152,165.3C1248,149,1344,171,1392,181.3L1440,192L1440,320L0,320Z"></path>
        </svg>
    </div>
</section>

<div class="container position-relative z-3" style="margin-top: -60px;">
    <div class="row g-4 justify-content-center">
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-lg text-center p-4 rounded-4 animate__animated animate__zoomIn">
                <h2 class="fw-bold text-primary mb-0">{{ stats.total_reports or 23 }}</h2>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Total Laporan</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-lg text-center p-4 rounded-4 animate__animated animate__zoomIn" style="animation-delay: 0.1s;">
                <h2 class="fw-bold text-success mb-0">{{ stats.selesai_reports or 8 }}</h2>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Selesai</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-lg text-center p-4 rounded-4 animate__animated animate__zoomIn" style="animation-delay: 0.2s;">
                <h2 class="fw-bold text-info mb-0">{{ stats.total_users or 5 }}</h2>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Warga Aktif</small>
            </div>
        </div>
    </div>
</div>

<div class="container my-5 pt-5" id="peta-pantauan">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 text-dark">
        <div class="text-center text-md-start mb-3 mb-md-0">
            <h2 class="fw-bold mb-0">Peta Pantauan Real-Time</h2>
            <p class="text-muted">Visualisasi sebaran laporan warga di Jombang ({{ stats.total_reports or 23 }} Pin)</p>
        </div>
        <div class="d-flex flex-wrap justify-content-center gap-2">
            <span class="badge bg-white text-dark border rounded-pill px-3 py-2 shadow-sm"><i class="bi bi-circle-fill text-primary me-1"></i> Biasa</span>
            <span class="badge bg-white text-dark border rounded-pill px-3 py-2 shadow-sm"><i class="bi bi-circle-fill text-warning me-1"></i> Sedang</span>
            <span class="badge bg-white text-dark border rounded-pill px-3 py-2 shadow-sm"><i class="bi bi-circle-fill text-danger me-1"></i> Darurat</span>
        </div>
    </div>

    <div class="card border-0 shadow-lg overflow-hidden rounded-4 position-relative">
        <div id="mapLoader" class="position-absolute top-50 start-50 translate-middle z-3 text-center bg-white bg-opacity-90 p-3 rounded shadow" style="display: none; z-index: 1000;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="small mt-2 mb-0 fw-bold">Sinkronisasi Pin...</p>
        </div>
        <div id="liveMap" style="height: 550px; width: 100%; z-index: 1;"></div>
    </div>
</div>

<div class="bg-light py-5">
    <div class="container py-4">
        <h2 class="text-center fw-bold mb-5 text-dark text-uppercase" style="letter-spacing: 1px;">Fitur Unggulan</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4 text-center rounded-4 hover-up shadow-hover">
                    <div class="icon-shape bg-soft-danger text-danger mb-4 mx-auto">
                        <i class="bi bi-broadcast fs-1"></i>
                    </div>
                    <h5 class="fw-bold">Early Warning System</h5>
                    <p class="text-muted small">Notifikasi otomatis berbasis lokasi untuk peringatan dini bencana.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4 text-center rounded-4 hover-up shadow-hover">
                    <div class="icon-shape bg-soft-primary text-primary mb-4 mx-auto">
                        <i class="bi bi-geo-alt fs-1"></i>
                    </div>
                    <h5 class="fw-bold">Geotagging Presisi</h5>
                    <p class="text-muted small">Setiap laporan dikunci dengan koordinat GPS akurat untuk verifikasi lapangan.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4 text-center rounded-4 hover-up shadow-hover">
                    <div class="icon-shape bg-soft-success text-success mb-4 mx-auto">
                        <i class="bi bi-shield-check fs-1"></i>
                    </div>
                    <h5 class="fw-bold">Database Terverifikasi</h5>
                    <p class="text-muted small">Integrasi data memastikan setiap laporan valid dan dapat dipertanggungjawabkan.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Inisialisasi Peta
    var map = L.map('liveMap', {
        scrollWheelZoom: false
    }).setView([-7.546, 112.233], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function loadMapMarkers() {
        document.getElementById('mapLoader').style.display = 'block';

        fetch('/admin/api/reports-map-data')
            .then(response => response.json())
            .then(data => {
                document.getElementById('mapLoader').style.display = 'none';

                data.forEach(report => {
                    // Validasi koordinat
                    let lat = parseFloat(report.lat || report.latitude);
                    let lng = parseFloat(report.lng || report.longitude);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        let color = '#0d6efd';
                        if(report.status_warna === 'merah') color = '#dc3545';
                        if(report.status_warna === 'kuning') color = '#ffc107';

                        var customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color:${color};" class="marker-pin"></div><i class="bi bi-geo-alt-fill" style="color:${color};"></i>`,
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        });

                        L.marker([lat, lng], {icon: customIcon})
                            .addTo(map)
                            .bindPopup(`
                                <div style="width:180px">
                                    <img src="/static/uploads/${report.foto || 'img2.png'}" class="img-fluid rounded mb-2" style="height:100px; width:100%; object-fit:cover;">
                                    <h6 class="fw-bold mb-1" style="font-size:13px">${report.judul || 'Laporan'}</h6>
                                    <p class="small text-muted mb-2">${report.created_at || ''}</p>
                                    <a href="${report.url_detail || '#'}" class="btn btn-primary btn-sm w-100" style="font-size:11px">Detail Laporan</a>
                                </div>
                            `);
                    }
                });
            })
            .catch(err => {
                console.error("Error loading pins:", err);
                document.getElementById('mapLoader').innerHTML = '<span class="text-danger">Gagal sinkronisasi data.</span>';
            });
    }

    document.addEventListener('DOMContentLoaded', loadMapMarkers);
</script>

<style>
    /* PIN DESIGN */
    .marker-pin {
        width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
        position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px;
        border: 2px solid white;
    }
    .custom-div-icon i {
        position: absolute; width: 22px; font-size: 22px; left: 0; right: 0; margin: 10px auto; text-align: center;
        z-index: 2;
    }

    /* UI ELEMENTS */
    .icon-shape { width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .bg-soft-danger { background-color: #ffeef0; }
    .bg-soft-primary { background-color: #e7f1ff; }
    .bg-soft-success { background-color: #e8fadf; }
    .hover-up:hover { transform: translateY(-5px); transition: 0.3s; }
    .shadow-hover:hover { box-shadow: 0 1rem 3rem rgba(0,0,0,.175)!important; }
    .leaflet-popup-content-wrapper { border-radius: 12px; }
</style>
{% endblock %}